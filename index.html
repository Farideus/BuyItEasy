<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Танковая игра</title>
<style>
  body {
    margin: 0; background: #222;
    overflow: hidden;
    user-select: none;
  }
  canvas {
    display: block;
    margin: auto;
    background: #7ec0ee; /* небо */
    border: 2px solid #444;
  }
</style>
</head>
<body>

<canvas id="game" width="800" height="400"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const gravity = 0.5;
const groundHeight = 60;

let keys = {};

// --- Класс танка ---
class Tank {
  constructor() {
    this.width = 60;
    this.height = 30;
    this.x = 100;
    this.y = canvas.height - groundHeight - this.height;
    this.vx = 0;
    this.color = "green";
    this.reloadTime = 0; // для задержки между выстрелами
  }
  update() {
    this.x += this.vx;
    if (this.x < 0) this.x = 0;
    if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;
    if (this.reloadTime > 0) this.reloadTime--;
  }
  draw() {
    ctx.fillStyle = this.color;
    ctx.fillRect(this.x, this.y, this.width, this.height);
    // башня
    ctx.fillRect(this.x + this.width/2 - 5, this.y - 15, 10, 15);
  }
  canShoot() {
    return this.reloadTime === 0;
  }
  shoot() {
    if (this.canShoot()) {
      bullets.push(new Bullet(this.x + this.width / 2, this.y - 15, 8, -10, "player"));
      this.reloadTime = 30; // задержка 30 кадров
    }
  }
  getRect() {
    return {x: this.x, y: this.y, width: this.width, height: this.height};
  }
}

// --- Пуля ---
class Bullet {
  constructor(x, y, radius, vy, owner) {
    this.x = x;
    this.y = y;
    this.radius = radius;
    this.vy = vy;
    this.owner = owner; // "player" или "enemy"
    this.active = true;
  }
  update() {
    this.y += this.vy;
    if (this.y < 0 || this.y > canvas.height) this.active = false;
  }
  draw() {
    ctx.beginPath();
    ctx.fillStyle = this.owner === "player" ? "yellow" : "red";
    ctx.shadowColor = this.owner === "player" ? "yellow" : "red";
    ctx.shadowBlur = 10;
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
  }
  getRect() {
    return {x: this.x - this.radius, y: this.y - this.radius, width: this.radius * 2, height: this.radius * 2};
  }
}

// --- Враг ---
class Enemy {
  constructor(x, y) {
    this.width = 50;
    this.height = 25;
    this.x = x;
    this.y = y;
    this.color = "gray";
    this.reloadTime = Math.floor(Math.random() * 120) + 60; // случайный перезаряд
    this.alive = true;
  }
  update() {
    if (this.reloadTime > 0) this.reloadTime--;
    else {
      bullets.push(new Bullet(this.x + this.width / 2, this.y + this.height, 8, 6, "enemy"));
      this.reloadTime = Math.floor(Math.random() * 120) + 60;
    }
  }
  draw() {
    if (!this.alive) return;
    ctx.fillStyle = this.color;
    ctx.fillRect(this.x, this.y, this.width, this.height);
    // башня
    ctx.fillRect(this.x + this.width/2 - 4, this.y + this.height, 8, 12);
  }
  getRect() {
    return {x: this.x, y: this.y, width: this.width, height: this.height};
  }
}

// Проверка пересечения прямоугольников (AABB)
function isColliding(r1, r2) {
  return (
    r1.x < r2.x + r2.width &&
    r1.x + r1.width > r2.x &&
    r1.y < r2.y + r2.height &&
    r1.y + r1.height > r2.y
  );
}

// --- Игровой цикл ---
const tank = new Tank();
const enemies = [
  new Enemy(300, canvas.height - groundHeight - 25),
  new Enemy(500, canvas.height - groundHeight - 25),
  new Enemy(700, canvas.height - groundHeight - 25),
];
const bullets = [];

function update() {
  // Управление танком
  tank.vx = 0;
  if (keys["ArrowLeft"]) tank.vx = -5;
  if (keys["ArrowRight"]) tank.vx = 5;
  if (keys[" "] || keys["Spacebar"]) {
    tank.shoot();
  }

  tank.update();

  enemies.forEach(enemy => enemy.update());

  bullets.forEach(bullet => bullet.update());

  // Проверка попаданий пуль
  for (let bullet of bullets) {
    if (!bullet.active) continue;
    const bRect = bullet.getRect();

    if (bullet.owner === "player") {
      // Проверяем попадание по врагам
      for (let enemy of enemies) {
        if (!enemy.alive) continue;
        if (isColliding(bRect, enemy.getRect())) {
          enemy.alive = false;
          bullet.active = false;
          break;
        }
      }
    } else {
      // Проверяем попадание по танку
      if (isColliding(bRect, tank.getRect())) {
        alert("Танк уничтожен! Игра окончена.");
        resetGame();
        break;
      }
    }
  }

  // Удаляем неактивные пули
  for (let i = bullets.length - 1; i >= 0; i--) {
    if (!bullets[i].active) bullets.splice(i, 1);
  }
}

function drawGround() {
  ctx.fillStyle = "#654321";
  ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight);
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // фон неба
  let grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
  grad.addColorStop(0, "#7ec0ee");
  grad.addColorStop(1, "#654321");
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  drawGround();

  tank.draw();
  enemies.forEach(enemy => enemy.draw());
  bullets.forEach(bullet => bullet.draw());
}

function gameLoop() {
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

function resetGame() {
  tank.x = 100;
  tank.y = canvas.height - groundHeight - tank.height;
  enemies.forEach(enemy => enemy.alive = true);
  bullets.length = 0;
}

window.addEventListener("keydown", (e) => {
  keys[e.key] = true;
  if (e.key === " ") e.preventDefault(); // чтобы пробел не скроллил страницу
});
window.addEventListener("keyup", (e) => {
  keys[e.key] = false;
});

gameLoop();
</script>

</body>
</html>
